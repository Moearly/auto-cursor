# 06 - è®¤è¯æ£€æŸ¥

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

è®¤è¯æ£€æŸ¥æ¨¡å—è´Ÿè´£æŸ¥è¯¢ Cursor çš„ç™»å½•çŠ¶æ€ã€è´¦æˆ·ä¿¡æ¯å’Œä½¿ç”¨ç»Ÿè®¡ï¼Œé€šè¿‡è°ƒç”¨ Cursor API è·å–è¯¦ç»†çš„ä½¿ç”¨æ•°æ®ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. è®¤è¯çŠ¶æ€æ£€æŸ¥
- âœ… æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
- âœ… éªŒè¯Tokenæœ‰æ•ˆæ€§
- âœ… è·å–è´¦æˆ·åŸºæœ¬ä¿¡æ¯
- âœ… æŸ¥è¯¢è®¢é˜…çŠ¶æ€

### 2. ä½¿ç”¨ç»Ÿè®¡
- âœ… Tokenä½¿ç”¨é‡æŸ¥è¯¢
- âœ… æ¨¡å‹è°ƒç”¨ç»Ÿè®¡
- âœ… èšåˆä½¿ç”¨æ•°æ®
- âœ… æˆæœ¬è®¡ç®—

### 3. ç”¨æˆ·åˆ†æ
- âœ… æ¯æ—¥æ´»è·ƒåº¦
- âœ… ä»£ç æ¥å—ç‡
- âœ… Composerè¯·æ±‚æ•°
- âœ… Agentè¯·æ±‚æ•°

## ğŸ—‚ï¸ æ•°æ®ç»“æ„

### UserAuthInfo ç»“æ„

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UserAuthInfo {
    pub is_authorized: bool,              // æ˜¯å¦å·²æˆæƒ
    pub token_length: usize,              // Tokené•¿åº¦
    pub token_valid: bool,                // Tokenæ˜¯å¦æœ‰æ•ˆ
    pub api_status: Option<u16>,          // APIçŠ¶æ€ç 
    pub error_message: Option<String>,    // é”™è¯¯ä¿¡æ¯
    pub checksum: Option<String>,         // Tokenæ ¡éªŒå’Œ
    pub account_info: Option<AccountInfo>,// è´¦æˆ·ä¿¡æ¯
}
```

### AccountInfo ç»“æ„

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AccountInfo {
    pub email: Option<String>,                      // é‚®ç®±
    pub username: Option<String>,                   // ç”¨æˆ·å
    pub subscription_type: Option<String>,          // è®¢é˜…ç±»å‹
    pub subscription_status: Option<String>,        // è®¢é˜…çŠ¶æ€
    pub trial_days_remaining: Option<i32>,          // è¯•ç”¨å‰©ä½™å¤©æ•°
    pub usage_info: Option<String>,                 // ä½¿ç”¨ä¿¡æ¯
    pub aggregated_usage: Option<AggregatedUsageData>, // èšåˆä½¿ç”¨æ•°æ®
}
```

### AggregatedUsageData ç»“æ„

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AggregatedUsageData {
    pub aggregations: Vec<ModelUsage>,      // æ¨¡å‹ä½¿ç”¨åˆ—è¡¨
    pub total_input_tokens: String,         // æ€»è¾“å…¥Token
    pub total_output_tokens: String,        // æ€»è¾“å‡ºToken
    pub total_cache_write_tokens: String,   // æ€»ç¼“å­˜å†™å…¥Token
    pub total_cache_read_tokens: String,    // æ€»ç¼“å­˜è¯»å–Token
    pub total_cost_cents: f64,              // æ€»æˆæœ¬ï¼ˆç¾åˆ†ï¼‰
}
```

### ModelUsage ç»“æ„

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ModelUsage {
    pub model_intent: String,           // æ¨¡å‹ç”¨é€”
    pub input_tokens: String,           // è¾“å…¥Token
    pub output_tokens: String,          // è¾“å‡ºToken
    pub cache_write_tokens: String,     // ç¼“å­˜å†™å…¥Token
    pub cache_read_tokens: String,      // ç¼“å­˜è¯»å–Token
    pub total_cents: f64,               // æˆæœ¬ï¼ˆç¾åˆ†ï¼‰
}
```

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. æ£€æŸ¥è®¤è¯çŠ¶æ€

```rust
#[tauri::command]
pub async fn check_cursor_auth() -> Result<UserAuthInfo, String> {
    log_info!("ğŸ” å¼€å§‹æ£€æŸ¥ Cursor è®¤è¯çŠ¶æ€...");
    
    // è·å–æ•°æ®åº“è·¯å¾„
    let (_, sqlite_path) = get_cursor_paths()
        .map_err(|e| format!("è·å–Cursorè·¯å¾„å¤±è´¥: {}", e))?;
    
    // æ‰“å¼€æ•°æ®åº“è¿æ¥
    let conn = Connection::open(&sqlite_path)
        .map_err(|e| format!("æ‰“å¼€æ•°æ®åº“å¤±è´¥: {}", e))?;
    
    // æŸ¥è¯¢Token
    let token_result: Result<String, rusqlite::Error> = conn.query_row(
        "SELECT value FROM ItemTable WHERE key = 'cursorAuth/accessToken'",
        [],
        |row| row.get(0),
    );
    
    match token_result {
        Ok(token) => {
            log_info!("âœ… æ‰¾åˆ°Tokenï¼Œé•¿åº¦: {}", token.len());
            
            // éªŒè¯Token
            let auth_info = verify_token_with_api(&token).await?;
            
            Ok(auth_info)
        }
        Err(_) => {
            log_warn!("âŒ æœªæ‰¾åˆ°Token");
            Ok(UserAuthInfo {
                is_authorized: false,
                token_length: 0,
                token_valid: false,
                api_status: None,
                error_message: Some("æœªæ‰¾åˆ°è®¤è¯Token".to_string()),
                checksum: None,
                account_info: None,
            })
        }
    }
}
```

### 2. éªŒè¯Tokenå¹¶è·å–è´¦æˆ·ä¿¡æ¯

```rust
async fn verify_token_with_api(token: &str) -> Result<UserAuthInfo, String> {
    // åˆ›å»ºHTTPå®¢æˆ·ç«¯
    let client = reqwest::Client::new();
    
    // è°ƒç”¨è®¤è¯API
    let response = client
        .get("https://api.cursor.sh/api/auth/status")
        .header("Authorization", format!("Bearer {}", token))
        .send()
        .await
        .map_err(|e| format!("APIè¯·æ±‚å¤±è´¥: {}", e))?;
    
    let status_code = response.status().as_u16();
    
    if status_code == 200 {
        // è§£æå“åº”
        let auth_data: serde_json::Value = response.json().await
            .map_err(|e| format!("è§£æå“åº”å¤±è´¥: {}", e))?;
        
        // æå–è´¦æˆ·ä¿¡æ¯
        let account_info = AccountInfo {
            email: auth_data["email"].as_str().map(String::from),
            username: auth_data["username"].as_str().map(String::from),
            subscription_type: auth_data["subscription"]["type"].as_str().map(String::from),
            subscription_status: auth_data["subscription"]["status"].as_str().map(String::from),
            trial_days_remaining: auth_data["trial_days_remaining"].as_i64().map(|v| v as i32),
            usage_info: None,
            aggregated_usage: None,
        };
        
        Ok(UserAuthInfo {
            is_authorized: true,
            token_length: token.len(),
            token_valid: true,
            api_status: Some(status_code),
            error_message: None,
            checksum: Some(calculate_token_checksum(token)),
            account_info: Some(account_info),
        })
    } else {
        Ok(UserAuthInfo {
            is_authorized: false,
            token_length: token.len(),
            token_valid: false,
            api_status: Some(status_code),
            error_message: Some(format!("APIè¿”å›é”™è¯¯: {}", status_code)),
            checksum: Some(calculate_token_checksum(token)),
            account_info: None,
        })
    }
}
```

### 3. è·å–ä½¿ç”¨ç»Ÿè®¡

```rust
#[tauri::command]
pub async fn get_usage_stats(
    start_date: Option<u64>,
    end_date: Option<u64>,
) -> Result<AggregatedUsageData, String> {
    log_info!("ğŸ“Š è·å–ä½¿ç”¨ç»Ÿè®¡...");
    
    // è·å–Token
    let token = get_token_from_db()?;
    
    // è®¾ç½®æ—¶é—´èŒƒå›´ï¼ˆé»˜è®¤æœ€è¿‘30å¤©ï¼‰
    let end = end_date.unwrap_or_else(|| {
        SystemTime::now()
            .duration_since(UNIX_EPOCH)
            .unwrap()
            .as_secs()
    });
    
    let start = start_date.unwrap_or(end - 30 * 24 * 60 * 60);
    
    // åˆ›å»ºHTTPå®¢æˆ·ç«¯
    let client = reqwest::Client::new();
    
    // æ„å»ºè¯·æ±‚ä½“
    let request_body = serde_json::json!({
        "start_date": start,
        "end_date": end,
        "team_id": 0
    });
    
    // è°ƒç”¨ä½¿ç”¨ç»Ÿè®¡API
    let response = client
        .post("https://api.cursor.sh/api/usage")
        .header("Authorization", format!("Bearer {}", token))
        .json(&request_body)
        .send()
        .await
        .map_err(|e| format!("APIè¯·æ±‚å¤±è´¥: {}", e))?;
    
    if response.status().is_success() {
        let usage_data: AggregatedUsageData = response.json().await
            .map_err(|e| format!("è§£æå“åº”å¤±è´¥: {}", e))?;
        
        log_info!("âœ… ä½¿ç”¨ç»Ÿè®¡è·å–æˆåŠŸ");
        Ok(usage_data)
    } else {
        Err(format!("è·å–ä½¿ç”¨ç»Ÿè®¡å¤±è´¥: {}", response.status()))
    }
}
```

### 4. è·å–èšåˆä½¿ç”¨æ•°æ®

```rust
#[tauri::command]
pub async fn get_aggregated_usage(
    start_date: Option<u64>,
    end_date: Option<u64>,
) -> Result<AggregatedUsageData, String> {
    log_info!("ğŸ“ˆ è·å–èšåˆä½¿ç”¨æ•°æ®...");
    
    let token = get_token_from_db()?;
    
    // è®¾ç½®æ—¶é—´èŒƒå›´
    let end = end_date.unwrap_or_else(|| {
        SystemTime::now()
            .duration_since(UNIX_EPOCH)
            .unwrap()
            .as_secs()
    });
    
    let start = start_date.unwrap_or(end - 30 * 24 * 60 * 60);
    
    let client = reqwest::Client::new();
    
    // è°ƒç”¨èšåˆAPI
    let response = client
        .get("https://api.cursor.sh/api/usage/aggregated")
        .header("Authorization", format!("Bearer {}", token))
        .query(&[
            ("start_date", start.to_string()),
            ("end_date", end.to_string()),
        ])
        .send()
        .await
        .map_err(|e| format!("APIè¯·æ±‚å¤±è´¥: {}", e))?;
    
    if response.status().is_success() {
        let usage_data: AggregatedUsageData = response.json().await
            .map_err(|e| format!("è§£æå“åº”å¤±è´¥: {}", e))?;
        
        // è®¡ç®—æ€»è®¡
        let total_input: u64 = usage_data.aggregations.iter()
            .filter_map(|m| m.input_tokens.parse::<u64>().ok())
            .sum();
        
        let total_output: u64 = usage_data.aggregations.iter()
            .filter_map(|m| m.output_tokens.parse::<u64>().ok())
            .sum();
        
        let total_cost: f64 = usage_data.aggregations.iter()
            .map(|m| m.total_cents)
            .sum();
        
        log_info!("âœ… èšåˆæ•°æ®è·å–æˆåŠŸ");
        log_info!("ğŸ“Š æ€»è¾“å…¥Token: {}", total_input);
        log_info!("ğŸ“Š æ€»è¾“å‡ºToken: {}", total_output);
        log_info!("ğŸ’° æ€»æˆæœ¬: ${:.2}", total_cost / 100.0);
        
        Ok(usage_data)
    } else {
        Err(format!("è·å–èšåˆæ•°æ®å¤±è´¥: {}", response.status()))
    }
}
```

### 5. è·å–ç”¨æˆ·åˆ†ææ•°æ®

```rust
#[tauri::command]
pub async fn get_user_analytics(
    start_date: Option<String>,
    end_date: Option<String>,
) -> Result<UserAnalyticsData, String> {
    log_info!("ğŸ“Š è·å–ç”¨æˆ·åˆ†ææ•°æ®...");
    
    let token = get_token_from_db()?;
    
    // è®¾ç½®æ—¥æœŸèŒƒå›´
    let end = end_date.unwrap_or_else(|| {
        chrono::Local::now().format("%Y-%m-%d").to_string()
    });
    
    let start = start_date.unwrap_or_else(|| {
        (chrono::Local::now() - chrono::Duration::days(30))
            .format("%Y-%m-%d")
            .to_string()
    });
    
    let client = reqwest::Client::new();
    
    // è°ƒç”¨åˆ†æAPI
    let response = client
        .get("https://api.cursor.sh/api/user-analytics")
        .header("Authorization", format!("Bearer {}", token))
        .query(&[
            ("start_date", start),
            ("end_date", end),
        ])
        .send()
        .await
        .map_err(|e| format!("APIè¯·æ±‚å¤±è´¥: {}", e))?;
    
    if response.status().is_success() {
        let analytics_data: UserAnalyticsData = response.json().await
            .map_err(|e| format!("è§£æå“åº”å¤±è´¥: {}", e))?;
        
        log_info!("âœ… ç”¨æˆ·åˆ†ææ•°æ®è·å–æˆåŠŸ");
        Ok(analytics_data)
    } else {
        Err(format!("è·å–åˆ†ææ•°æ®å¤±è´¥: {}", response.status()))
    }
}
```

## ğŸ“Š API ç«¯ç‚¹

### 1. è®¤è¯çŠ¶æ€
```
GET https://api.cursor.sh/api/auth/status
Headers:
  Authorization: Bearer <token>

Response:
{
  "email": "user@example.com",
  "username": "username",
  "subscription": {
    "type": "pro",
    "status": "active"
  },
  "trial_days_remaining": 14
}
```

### 2. ä½¿ç”¨ç»Ÿè®¡
```
POST https://api.cursor.sh/api/usage
Headers:
  Authorization: Bearer <token>
Body:
{
  "start_date": 1698768000,
  "end_date": 1701360000,
  "team_id": 0
}

Response:
{
  "aggregations": [
    {
      "model_intent": "chat",
      "input_tokens": "1000000",
      "output_tokens": "500000",
      "cache_write_tokens": "100000",
      "cache_read_tokens": "50000",
      "total_cents": 25.50
    }
  ],
  "total_input_tokens": "1000000",
  "total_output_tokens": "500000",
  "total_cache_write_tokens": "100000",
  "total_cache_read_tokens": "50000",
  "total_cost_cents": 25.50
}
```

### 3. èšåˆä½¿ç”¨æ•°æ®
```
GET https://api.cursor.sh/api/usage/aggregated
Headers:
  Authorization: Bearer <token>
Query:
  start_date: 1698768000
  end_date: 1701360000

Response: (åŒä¸Š)
```

### 4. ç”¨æˆ·åˆ†æ
```
GET https://api.cursor.sh/api/user-analytics
Headers:
  Authorization: Bearer <token>
Query:
  start_date: 2025-10-01
  end_date: 2025-10-28

Response:
{
  "dailyMetrics": [
    {
      "date": "2025-10-28",
      "activeUsers": 1,
      "acceptedLinesAdded": 1250,
      "acceptedLinesDeleted": 350,
      "totalApplies": 45,
      "totalAccepts": 38,
      "totalTabsShown": 120,
      "totalTabsAccepted": 95,
      "composerRequests": 25,
      "agentRequests": 10
    }
  ],
  "period": {
    "start": "2025-10-01",
    "end": "2025-10-28"
  },
  "totalMembersInTeam": 1
}
```

## ğŸ¨ å‰ç«¯ç•Œé¢

### AuthCheckPage ç»„ä»¶

```typescript
export const AuthCheckPage: React.FC = () => {
  const [authInfo, setAuthInfo] = useState<UserAuthInfo | null>(null);
  const [usageData, setUsageData] = useState<AggregatedUsageData | null>(null);
  const [loading, setLoading] = useState(false);
  
  // æ£€æŸ¥è®¤è¯çŠ¶æ€
  const checkAuth = async () => {
    setLoading(true);
    try {
      const result = await invoke<UserAuthInfo>('check_cursor_auth');
      setAuthInfo(result);
      
      if (result.is_authorized) {
        // è·å–ä½¿ç”¨ç»Ÿè®¡
        const usage = await invoke<AggregatedUsageData>('get_aggregated_usage');
        setUsageData(usage);
      }
    } catch (error) {
      console.error('æ£€æŸ¥è®¤è¯å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="space-y-6">
      {/* è®¤è¯çŠ¶æ€å¡ç‰‡ */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-bold mb-4">ğŸ” è®¤è¯çŠ¶æ€</h2>
        
        {authInfo && (
          <div className="space-y-2">
            <div className="flex items-center">
              <span className={authInfo.is_authorized ? 'text-green-500' : 'text-red-500'}>
                {authInfo.is_authorized ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}
              </span>
            </div>
            
            {authInfo.account_info && (
              <>
                <p><strong>é‚®ç®±:</strong> {authInfo.account_info.email}</p>
                <p><strong>è®¢é˜…ç±»å‹:</strong> {authInfo.account_info.subscription_type}</p>
                <p><strong>è®¢é˜…çŠ¶æ€:</strong> {authInfo.account_info.subscription_status}</p>
                {authInfo.account_info.trial_days_remaining && (
                  <p><strong>è¯•ç”¨å‰©ä½™:</strong> {authInfo.account_info.trial_days_remaining} å¤©</p>
                )}
              </>
            )}
          </div>
        )}
        
        <button onClick={checkAuth} disabled={loading}>
          {loading ? 'æ£€æŸ¥ä¸­...' : 'æ£€æŸ¥è®¤è¯çŠ¶æ€'}
        </button>
      </div>
      
      {/* ä½¿ç”¨ç»Ÿè®¡å¡ç‰‡ */}
      {usageData && (
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-bold mb-4">ğŸ“Š ä½¿ç”¨ç»Ÿè®¡</h2>
          
          <div className="grid grid-cols-2 gap-4 mb-6">
            <div className="bg-blue-50 p-4 rounded">
              <p className="text-sm text-gray-600">æ€»è¾“å…¥Token</p>
              <p className="text-2xl font-bold">{usageData.total_input_tokens}</p>
            </div>
            
            <div className="bg-green-50 p-4 rounded">
              <p className="text-sm text-gray-600">æ€»è¾“å‡ºToken</p>
              <p className="text-2xl font-bold">{usageData.total_output_tokens}</p>
            </div>
            
            <div className="bg-purple-50 p-4 rounded">
              <p className="text-sm text-gray-600">ç¼“å­˜å†™å…¥</p>
              <p className="text-2xl font-bold">{usageData.total_cache_write_tokens}</p>
            </div>
            
            <div className="bg-orange-50 p-4 rounded">
              <p className="text-sm text-gray-600">æ€»æˆæœ¬</p>
              <p className="text-2xl font-bold">${(usageData.total_cost_cents / 100).toFixed(2)}</p>
            </div>
          </div>
          
          {/* æ¨¡å‹ä½¿ç”¨è¯¦æƒ… */}
          <h3 className="font-bold mb-2">æ¨¡å‹ä½¿ç”¨è¯¦æƒ…</h3>
          <div className="space-y-2">
            {usageData.aggregations.map((model, index) => (
              <div key={index} className="border-b pb-2">
                <p className="font-medium">{model.model_intent}</p>
                <div className="grid grid-cols-4 gap-2 text-sm text-gray-600">
                  <div>è¾“å…¥: {model.input_tokens}</div>
                  <div>è¾“å‡º: {model.output_tokens}</div>
                  <div>ç¼“å­˜: {model.cache_write_tokens}</div>
                  <div>æˆæœ¬: ${(model.total_cents / 100).toFixed(2)}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Tokenæœªæ‰¾åˆ°

**ç—‡çŠ¶**ï¼šæç¤º"æœªæ‰¾åˆ°è®¤è¯Token"

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ•°æ®åº“
sqlite3 state.vscdb "SELECT key, value FROM ItemTable WHERE key LIKE '%token%'"

# ç¡®è®¤æ˜¯å¦å·²ç™»å½•Cursor
```

#### 2. APIè¯·æ±‚å¤±è´¥

**ç—‡çŠ¶**ï¼šè¿”å›401æˆ–403é”™è¯¯

**åŸå› **ï¼š
- Tokenå·²è¿‡æœŸ
- Tokenæ ¼å¼ä¸æ­£ç¡®
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é‡æ–°ç™»å½•Cursor
- æ£€æŸ¥Tokenæ ¼å¼
- æ£€æŸ¥ç½‘ç»œè¿æ¥

#### 3. ä½¿ç”¨ç»Ÿè®¡ä¸ºç©º

**ç—‡çŠ¶**ï¼šè¿”å›ç©ºæ•°æ®

**åŸå› **ï¼š
- æ—¶é—´èŒƒå›´å†…æ— ä½¿ç”¨è®°å½•
- APIå‚æ•°é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è°ƒæ•´æ—¶é—´èŒƒå›´
- æ£€æŸ¥APIå‚æ•°

## ğŸ“ˆ æ•°æ®å¯è§†åŒ–

### ä½¿ç”¨è¶‹åŠ¿å›¾

```typescript
import { Line } from 'react-chartjs-2';

const UsageChart: React.FC<{ data: DailyMetric[] }> = ({ data }) => {
  const chartData = {
    labels: data.map(d => d.date),
    datasets: [
      {
        label: 'Composerè¯·æ±‚',
        data: data.map(d => d.composerRequests || 0),
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      },
      {
        label: 'Agentè¯·æ±‚',
        data: data.map(d => d.agentRequests || 0),
        borderColor: 'rgb(255, 99, 132)',
        tension: 0.1
      }
    ]
  };
  
  return <Line data={chartData} />;
};
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Tokenå®‰å…¨**ï¼šä¸è¦æ³„éœ²Token
2. **APIé™åˆ¶**ï¼šæ³¨æ„APIè°ƒç”¨é¢‘ç‡
3. **æ•°æ®éšç§**ï¼šå¦¥å–„ä¿ç®¡ä½¿ç”¨æ•°æ®
4. **æ—¶åŒºé—®é¢˜**ï¼šæ³¨æ„æ—¶é—´èŒƒå›´çš„æ—¶åŒºè½¬æ¢

---

**æœ€åæ›´æ–°**ï¼š2025-10-28
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0.0

