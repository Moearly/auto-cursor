# 09 - 部署指南

## 📋 部署概述

本文档介绍如何构建和部署 Auto-Cursor 应用到不同平台。

## 🛠️ 开发环境准备

### 1. 系统要求

#### Windows
- Windows 10 或更高版本
- Visual Studio 2019 或更高版本（C++ 构建工具）
- Node.js 18+
- Rust 1.70+

#### macOS
- macOS 10.15 (Catalina) 或更高版本
- Xcode Command Line Tools
- Node.js 18+
- Rust 1.70+

#### Linux
- Ubuntu 20.04 或更高版本（或其他主流发行版）
- 构建工具：gcc, make, pkg-config
- Node.js 18+
- Rust 1.70+

### 2. 安装依赖

#### 安装 Node.js
```bash
# 使用 nvm (推荐)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18

# 或直接下载
# https://nodejs.org/
```

#### 安装 Rust
```bash
# Unix/Linux/macOS
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Windows
# 下载并运行 rustup-init.exe
# https://rustup.rs/
```

#### 安装 pnpm
```bash
npm install -g pnpm
```

### 3. 克隆项目

```bash
git clone <repository-url>
cd auto-cursor
```

### 4. 安装项目依赖

```bash
# 安装前端依赖
pnpm install

# Rust 依赖会在构建时自动安装
```

## 🚀 开发模式

### 启动开发服务器

```bash
# 启动 Tauri 开发模式
pnpm tauri dev

# 或使用 npm
npm run tauri dev
```

这将：
1. 启动 Vite 开发服务器（端口 1420）
2. 编译 Rust 后端
3. 启动 Tauri 应用窗口
4. 启用热重载

### 开发调试

```bash
# 查看 Rust 日志
RUST_LOG=debug pnpm tauri dev

# 前端调试
# 在应用中按 F12 打开开发者工具（需要注释掉禁用代码）
```

## 📦 构建生产版本

### 1. 构建前准备

#### 检查版本号
```json
// src-tauri/tauri.conf.json
{
  "version": "0.8.0"
}

// package.json
{
  "version": "0.1.0"
}
```

#### 准备图标
```
src-tauri/icons/
├── 32x32.png
├── 128x128.png
├── 128x128@2x.png
├── icon.icns      # macOS
└── icon.ico       # Windows
```

### 2. 构建命令

#### Windows
```bash
# 构建 Windows 安装包
pnpm tauri build

# 输出位置
# src-tauri/target/release/auto-cursor.exe
# src-tauri/target/release/bundle/msi/auto-cursor_0.8.0_x64_en-US.msi
```

#### macOS

##### Intel Mac
```bash
# 构建 x86_64 版本
pnpm tauri:build:intel

# 或
pnpm tauri build --target x86_64-apple-darwin
```

##### Apple Silicon
```bash
# 构建 aarch64 版本
pnpm tauri:build:m1

# 或
pnpm tauri build --target aarch64-apple-darwin
```

##### Universal Binary（推荐）
```bash
# 构建通用二进制（同时支持 Intel 和 Apple Silicon）
pnpm tauri:build:universal

# 或
pnpm tauri build --target universal-apple-darwin
```

##### 使用构建脚本
```bash
# 使用自定义构建脚本
pnpm tauri:build:macos

# 这将执行 scripts/build-macos.sh
```

**build-macos.sh 内容**：
```bash
#!/bin/bash

echo "🚀 开始构建 macOS 应用..."

# 构建 Universal Binary
echo "📦 构建 Universal Binary..."
pnpm tauri build --target universal-apple-darwin

# 检查构建结果
if [ $? -eq 0 ]; then
    echo "✅ 构建成功！"
    echo "📁 输出位置："
    echo "   - src-tauri/target/universal-apple-darwin/release/bundle/dmg/"
    echo "   - src-tauri/target/universal-apple-darwin/release/bundle/macos/"
else
    echo "❌ 构建失败！"
    exit 1
fi
```

#### Linux
```bash
# 构建 Linux 包
pnpm tauri build

# 输出位置
# src-tauri/target/release/auto-cursor
# src-tauri/target/release/bundle/deb/auto-cursor_0.8.0_amd64.deb
# src-tauri/target/release/bundle/appimage/auto-cursor_0.8.0_amd64.AppImage
```

### 3. 构建输出

#### Windows
```
src-tauri/target/release/
├── auto-cursor.exe                    # 可执行文件
└── bundle/
    ├── msi/
    │   └── auto-cursor_0.8.0_x64_en-US.msi  # MSI 安装包
    └── nsis/
        └── auto-cursor_0.8.0_x64-setup.exe   # NSIS 安装包
```

#### macOS
```
src-tauri/target/universal-apple-darwin/release/
├── auto-cursor                        # 可执行文件
└── bundle/
    ├── dmg/
    │   └── auto-cursor_0.8.0_universal.dmg   # DMG 镜像
    └── macos/
        └── auto-cursor.app                    # 应用包
```

#### Linux
```
src-tauri/target/release/
├── auto-cursor                        # 可执行文件
└── bundle/
    ├── deb/
    │   └── auto-cursor_0.8.0_amd64.deb       # Debian 包
    └── appimage/
        └── auto-cursor_0.8.0_amd64.AppImage  # AppImage
```

## 🔧 构建优化

### 1. 减小文件大小

**Cargo.toml 优化配置**：
```toml
[profile.release]
opt-level = "z"        # 优化大小
lto = true             # 链接时优化
codegen-units = 1      # 单一代码生成单元
panic = "abort"        # 使用 abort
strip = true           # 去除调试符号
```

### 2. 加速构建

```bash
# 使用 sccache 缓存编译结果
cargo install sccache
export RUSTC_WRAPPER=sccache

# 并行编译
export CARGO_BUILD_JOBS=8
```

### 3. 条件编译

```rust
// 仅在 release 模式下包含
#[cfg(not(debug_assertions))]
fn production_only() {
    // ...
}

// 仅在 debug 模式下包含
#[cfg(debug_assertions)]
fn debug_only() {
    // ...
}
```

## 📤 发布流程

### 1. 版本管理

#### 更新版本号
```bash
# 更新 package.json
npm version patch  # 0.1.0 -> 0.1.1
npm version minor  # 0.1.0 -> 0.2.0
npm version major  # 0.1.0 -> 1.0.0

# 手动更新 tauri.conf.json
# "version": "0.8.0"
```

#### 创建 Git 标签
```bash
git tag -a v0.8.0 -m "Release v0.8.0"
git push origin v0.8.0
```

### 2. GitHub Releases

#### 创建 Release
```bash
# 使用 GitHub CLI
gh release create v0.8.0 \
  --title "Auto-Cursor v0.8.0" \
  --notes "Release notes here" \
  src-tauri/target/release/bundle/**/*
```

#### 上传脚本 (scripts/upload.sh)
```bash
#!/bin/bash

VERSION="0.8.0"
GITHUB_REPO="username/auto-cursor"
GITHUB_TOKEN="your_token"

echo "📤 上传 v${VERSION} 到 GitHub Releases..."

# Windows
gh release upload v${VERSION} \
  src-tauri/target/release/bundle/msi/*.msi

# macOS
gh release upload v${VERSION} \
  src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg

# Linux
gh release upload v${VERSION} \
  src-tauri/target/release/bundle/deb/*.deb \
  src-tauri/target/release/bundle/appimage/*.AppImage

echo "✅ 上传完成！"
```

### 3. 自动更新

#### 配置更新服务器
```json
// tauri.conf.json
{
  "updater": {
    "active": true,
    "endpoints": [
      "https://releases.example.com/{{target}}/{{current_version}}"
    ],
    "dialog": true,
    "pubkey": "your_public_key"
  }
}
```

#### 生成更新签名
```bash
# 生成密钥对
tauri signer generate -w ~/.tauri/myapp.key

# 签名更新文件
tauri signer sign \
  -k ~/.tauri/myapp.key \
  src-tauri/target/release/bundle/msi/auto-cursor_0.8.0_x64_en-US.msi
```

## 🐳 Docker 构建（可选）

### Dockerfile
```dockerfile
FROM rust:1.70 as builder

# 安装 Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
RUN apt-get install -y nodejs

# 安装 pnpm
RUN npm install -g pnpm

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libwebkit2gtk-4.0-dev \
    build-essential \
    curl \
    wget \
    libssl-dev \
    libgtk-3-dev \
    libayatana-appindicator3-dev \
    librsvg2-dev

WORKDIR /app

# 复制项目文件
COPY . .

# 安装依赖
RUN pnpm install

# 构建
RUN pnpm tauri build

# 输出构建产物
FROM scratch AS export
COPY --from=builder /app/src-tauri/target/release/bundle /
```

### 使用 Docker 构建
```bash
# 构建
docker build -t auto-cursor-builder .

# 导出构建产物
docker build --output type=local,dest=./dist -f Dockerfile .
```

## 🧪 测试构建

### 1. 本地测试

```bash
# 构建并运行
pnpm tauri build
./src-tauri/target/release/auto-cursor

# macOS
open src-tauri/target/universal-apple-darwin/release/bundle/macos/auto-cursor.app
```

### 2. 安装测试

#### Windows
```bash
# 安装 MSI
msiexec /i src-tauri/target/release/bundle/msi/auto-cursor_0.8.0_x64_en-US.msi
```

#### macOS
```bash
# 挂载 DMG
hdiutil attach src-tauri/target/universal-apple-darwin/release/bundle/dmg/auto-cursor_0.8.0_universal.dmg

# 复制到 Applications
cp -R /Volumes/auto-cursor/auto-cursor.app /Applications/
```

#### Linux
```bash
# 安装 DEB
sudo dpkg -i src-tauri/target/release/bundle/deb/auto-cursor_0.8.0_amd64.deb

# 或运行 AppImage
chmod +x src-tauri/target/release/bundle/appimage/auto-cursor_0.8.0_amd64.AppImage
./src-tauri/target/release/bundle/appimage/auto-cursor_0.8.0_amd64.AppImage
```

## 🔍 故障排除

### 常见构建错误

#### 1. Rust 编译错误
```bash
# 清理构建缓存
cargo clean

# 更新 Rust
rustup update

# 重新构建
pnpm tauri build
```

#### 2. Node 模块错误
```bash
# 删除 node_modules
rm -rf node_modules

# 清理缓存
pnpm store prune

# 重新安装
pnpm install
```

#### 3. macOS 签名问题
```bash
# 临时禁用签名验证（仅用于开发）
sudo spctl --master-disable

# 签名应用
codesign --force --deep --sign - auto-cursor.app
```

#### 4. Linux 依赖缺失
```bash
# Ubuntu/Debian
sudo apt-get install -y \
    libwebkit2gtk-4.0-dev \
    build-essential \
    curl \
    wget \
    libssl-dev \
    libgtk-3-dev \
    libayatana-appindicator3-dev \
    librsvg2-dev

# Fedora
sudo dnf install -y \
    webkit2gtk3-devel \
    openssl-devel \
    curl \
    wget \
    gtk3-devel \
    librsvg2-devel
```

## 📊 构建性能

### 构建时间参考

| 平台 | 配置 | 首次构建 | 增量构建 |
|------|------|----------|----------|
| Windows | i7-10700, 16GB RAM | ~15分钟 | ~3分钟 |
| macOS Intel | i9-9900K, 32GB RAM | ~12分钟 | ~2分钟 |
| macOS M1 | M1 Pro, 16GB RAM | ~8分钟 | ~1分钟 |
| Linux | Ryzen 7 5800X, 32GB RAM | ~10分钟 | ~2分钟 |

### 优化建议

1. **使用 SSD**：显著提升编译速度
2. **增加内存**：至少 16GB
3. **使用缓存**：sccache 或 mold
4. **并行编译**：设置 CARGO_BUILD_JOBS
5. **增量编译**：避免 cargo clean

## 📝 检查清单

### 发布前检查

- [ ] 更新版本号
- [ ] 更新 CHANGELOG
- [ ] 测试所有功能
- [ ] 检查日志输出
- [ ] 测试更新功能
- [ ] 准备发布说明
- [ ] 创建 Git 标签
- [ ] 构建所有平台
- [ ] 测试安装包
- [ ] 上传到 GitHub Releases
- [ ] 更新文档

---

**最后更新**：2025-10-28
**文档版本**：1.0.0

