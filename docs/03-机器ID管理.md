# 03 - 机器ID管理

## 📋 功能概述

机器ID管理是 Auto-Cursor 的核心功能之一，负责管理 Cursor 编辑器的机器标识信息。通过备份、恢复和重置机器ID，可以实现多种高级功能。

## 🎯 核心功能

### 1. 机器ID生成
- ✅ UUID v4 生成（devDeviceId）
- ✅ SHA256 哈希生成（machineId，64字符）
- ✅ SHA512 哈希生成（macMachineId，128字符）
- ✅ GUID 格式生成（sqmId）

### 2. 备份管理
- ✅ 自动创建备份
- ✅ 列出所有备份文件
- ✅ 预览备份内容
- ✅ 从备份恢复

### 3. 文件修改
- ✅ 修改 storage.json
- ✅ 更新 SQLite 数据库
- ✅ 修改 machineId 文件
- ✅ 修改 main.js
- ✅ 修改 workbench.desktop.main.js

### 4. 系统ID更新
- ✅ Windows 注册表更新
- ✅ macOS plist 文件更新
- ✅ Linux 配置文件更新

## 🗂️ 机器ID结构

### MachineIds 数据结构

```rust
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct MachineIds {
    #[serde(rename = "telemetry.devDeviceId")]
    pub dev_device_id: String,        // UUID格式
    
    #[serde(rename = "telemetry.macMachineId")]
    pub mac_machine_id: String,       // 128字符SHA512
    
    #[serde(rename = "telemetry.machineId")]
    pub machine_id: String,           // 64字符SHA256
    
    #[serde(rename = "telemetry.sqmId")]
    pub sqm_id: String,               // {UUID}格式
    
    #[serde(rename = "storage.serviceMachineId")]
    pub service_machine_id: String,   // 同devDeviceId
}
```

### 示例数据

```json
{
  "telemetry.devDeviceId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "telemetry.macMachineId": "a1b2c3d4e5f67890abcdef1234567890a1b2c3d4e5f67890abcdef1234567890a1b2c3d4e5f67890abcdef1234567890a1b2c3d4e5f67890abcdef1234567890",
  "telemetry.machineId": "a1b2c3d4e5f67890abcdef1234567890a1b2c3d4e5f67890abcdef12345678",
  "telemetry.sqmId": "{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}",
  "storage.serviceMachineId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

## 📁 文件路径

### Windows
```
%APPDATA%\Cursor\
├── User\
│   └── globalStorage\
│       ├── storage.json              # 主配置文件
│       ├── storage.json.bak.*        # 备份文件
│       └── state.vscdb               # SQLite数据库
└── machineId                         # 机器ID文件
```

### macOS
```
~/Library/Application Support/Cursor/
├── User/
│   └── globalStorage/
│       ├── storage.json
│       ├── storage.json.bak.*
│       └── state.vscdb
└── machineId
```

### Linux
```
~/.config/Cursor/
├── User/
│   └── globalStorage/
│       ├── storage.json
│       ├── storage.json.bak.*
│       └── state.vscdb
└── machineId
```

## 🔧 核心实现

### 1. 生成新机器ID

```rust
pub fn generate_new_machine_ids(&self) -> Result<MachineIds> {
    // 生成 UUID
    let dev_device_id = Uuid::new_v4().to_string();
    
    // 生成 64字符 SHA256
    let mut machine_id_data = [0u8; 32];
    rand::thread_rng().fill(&mut machine_id_data);
    let machine_id = format!("{:x}", Sha256::digest(&machine_id_data));
    
    // 生成 128字符 SHA512
    let mut mac_machine_id_data = [0u8; 64];
    rand::thread_rng().fill(&mut mac_machine_id_data);
    let mac_machine_id = format!("{:x}", Sha512::digest(&mac_machine_id_data));
    
    // 生成 GUID 格式
    let sqm_id = format!("{{{}}}", Uuid::new_v4().to_string().to_uppercase());
    
    Ok(MachineIds {
        dev_device_id: dev_device_id.clone(),
        mac_machine_id,
        machine_id,
        sqm_id,
        service_machine_id: dev_device_id,
    })
}
```

### 2. 更新 storage.json

```rust
pub fn update_storage_file(&self, ids: &MachineIds) -> Result<()> {
    // 读取当前文件
    let content = fs::read_to_string(&self.db_path)?;
    let mut data: serde_json::Value = serde_json::from_str(&content)?;
    
    // 更新所有ID字段
    if let Some(obj) = data.as_object_mut() {
        obj.insert("telemetry.devDeviceId".to_string(), 
                   serde_json::Value::String(ids.dev_device_id.clone()));
        obj.insert("telemetry.macMachineId".to_string(), 
                   serde_json::Value::String(ids.mac_machine_id.clone()));
        obj.insert("telemetry.machineId".to_string(), 
                   serde_json::Value::String(ids.machine_id.clone()));
        obj.insert("telemetry.sqmId".to_string(), 
                   serde_json::Value::String(ids.sqm_id.clone()));
        obj.insert("storage.serviceMachineId".to_string(), 
                   serde_json::Value::String(ids.service_machine_id.clone()));
    }
    
    // 写回文件
    let updated_content = serde_json::to_string_pretty(&data)?;
    fs::write(&self.db_path, updated_content)?;
    
    Ok(())
}
```

### 3. 更新 machineId 文件

```rust
pub fn update_machine_id_file(&self, dev_device_id: &str) -> Result<()> {
    let machine_id_path = Self::get_machine_id_path()?;
    
    // 创建目录
    if let Some(parent) = machine_id_path.parent() {
        fs::create_dir_all(parent)?;
    }
    
    // 备份现有文件
    if machine_id_path.exists() {
        let timestamp = chrono::Local::now().format("%Y%m%d_%H%M%S").to_string();
        let backup_path = format!("{}.bak.{}", machine_id_path.to_string_lossy(), timestamp);
        fs::copy(&machine_id_path, backup_path)?;
    }
    
    // 写入新ID
    fs::write(&machine_id_path, dev_device_id)?;
    
    Ok(())
}
```

### 4. 更新系统ID

#### Windows 注册表
```rust
#[cfg(target_os = "windows")]
pub fn update_system_ids(&self, ids: &MachineIds) -> Result<Vec<String>> {
    use winreg::RegKey;
    use winreg::enums::*;
    
    let mut results = Vec::new();
    
    // 更新 MachineGuid
    match RegKey::predef(HKEY_LOCAL_MACHINE).open_subkey_with_flags(
        "SOFTWARE\\Microsoft\\Cryptography",
        KEY_WRITE | KEY_WOW64_64KEY,
    ) {
        Ok(key) => {
            if key.set_value("MachineGuid", &ids.dev_device_id).is_ok() {
                results.push("Windows MachineGuid updated successfully".to_string());
            }
        }
        Err(_) => {
            results.push("Permission denied: Cannot update Windows MachineGuid".to_string())
        }
    }
    
    // 更新 SQMClient MachineId
    match RegKey::predef(HKEY_LOCAL_MACHINE).open_subkey_with_flags(
        "SOFTWARE\\Microsoft\\SQMClient",
        KEY_WRITE | KEY_WOW64_64KEY,
    ) {
        Ok(key) => {
            if key.set_value("MachineId", &ids.sqm_id).is_ok() {
                results.push("Windows SQM MachineId updated successfully".to_string());
            }
        }
        Err(_) => {
            results.push("SQMClient registry key not found or permission denied".to_string())
        }
    }
    
    Ok(results)
}
```

#### macOS plist
```rust
#[cfg(target_os = "macos")]
pub fn update_system_ids(&self, ids: &MachineIds) -> Result<Vec<String>> {
    let mut results = Vec::new();
    
    let uuid_file = "/var/root/Library/Preferences/SystemConfiguration/com.apple.platform.uuid.plist";
    
    if Path::new(uuid_file).exists() {
        let cmd = format!(
            "sudo plutil -replace \"UUID\" -string \"{}\" \"{}\"",
            ids.mac_machine_id, uuid_file
        );
        
        match std::process::Command::new("sh")
            .arg("-c")
            .arg(&cmd)
            .output()
        {
            Ok(output) => {
                if output.status.success() {
                    results.push("macOS platform UUID updated successfully".to_string());
                } else {
                    results.push("Failed to execute plutil command".to_string());
                }
            }
            Err(_) => {
                results.push("Failed to update macOS platform UUID".to_string());
            }
        }
    }
    
    Ok(results)
}
```

## 🔄 完整重置流程

### 重置步骤

```rust
pub fn complete_cursor_reset(&self) -> Result<ResetResult> {
    let mut details = Vec::new();
    
    // 步骤1: 记录系统信息
    self.log_system_info();
    
    // 步骤2: 创建备份
    match self.create_backup() {
        Ok(backup_path) => {
            details.push(format!("Created backup at: {}", backup_path));
        }
        Err(e) => {
            details.push(format!("Warning: Failed to create backup: {}", e));
        }
    }
    
    // 步骤3: 生成新机器ID
    let new_ids = self.generate_new_machine_ids()?;
    details.push("Generated new machine IDs".to_string());
    
    // 步骤4: 更新 storage.json
    self.update_storage_file(&new_ids)?;
    details.push("Successfully updated storage.json".to_string());
    
    // 步骤5: 更新 SQLite 数据库
    match self.update_sqlite_db(&new_ids) {
        Ok(sqlite_results) => details.extend(sqlite_results),
        Err(e) => details.push(format!("Warning: Failed to update SQLite: {}", e)),
    }
    
    // 步骤6: 更新 machineId 文件
    self.update_machine_id_file(&new_ids.dev_device_id)?;
    details.push("Successfully updated machine ID file".to_string());
    
    // 步骤7: 更新系统ID
    match self.update_system_ids(&new_ids) {
        Ok(system_results) => details.extend(system_results),
        Err(e) => details.push(format!("Warning: Failed to update system IDs: {}", e)),
    }
    
    // 步骤8: 修改 main.js
    match Self::get_cursor_app_paths() {
        Ok((_, main_js)) => {
            if main_js.exists() {
                self.modify_main_js(&main_js)?;
                details.push("Successfully modified main.js".to_string());
            }
        }
        Err(e) => details.push(format!("Warning: Could not locate main.js: {}", e)),
    }
    
    // 步骤9: 修改 workbench.desktop.main.js
    match Self::get_workbench_js_path() {
        Ok(workbench_path) => {
            if workbench_path.exists() {
                self.modify_workbench_js(&workbench_path)?;
                details.push("Successfully modified workbench.desktop.main.js".to_string());
            }
        }
        Err(e) => details.push(format!("Warning: Could not locate workbench.js: {}", e)),
    }
    
    Ok(ResetResult {
        success: true,
        message: "Complete Cursor reset successful".to_string(),
        details,
        new_ids: Some(new_ids),
    })
}
```

## 📝 日志系统

### 日志级别
- **INFO**：一般信息
- **WARN**：警告信息
- **ERROR**：错误信息
- **DEBUG**：调试信息

### 日志文件
```
cursor_reset_YYYYMMDD_HHMMSS.log
```

### 日志示例
```
[2025-10-28 10:30:15.123] [INFO] === 系统信息 ===
[2025-10-28 10:30:15.124] [INFO] 操作系统: windows
[2025-10-28 10:30:15.125] [INFO] 架构: x86_64
[2025-10-28 10:30:15.126] [INFO] 存储文件路径: "C:\\Users\\...\\storage.json"
[2025-10-28 10:30:15.127] [INFO] SQLite路径: "C:\\Users\\...\\state.vscdb"
[2025-10-28 10:30:15.128] [INFO] 开始机器ID重置流程...
[2025-10-28 10:30:15.200] [INFO] 创建备份文件...
[2025-10-28 10:30:15.250] [INFO] 生成新的机器ID...
[2025-10-28 10:30:15.300] [INFO] 更新存储文件...
[2025-10-28 10:30:15.350] [INFO] 更新SQLite数据库...
[2025-10-28 10:30:15.400] [INFO] 机器ID重置完成
```

## 🎨 前端界面

### 主要组件

#### MachineIdPage.tsx
```typescript
export const MachineIdPage: React.FC = () => {
  const [backups, setBackups] = useState<BackupInfo[]>([]);
  const [selectedBackup, setSelectedBackup] = useState<BackupInfo | null>(null);
  const [previewIds, setPreviewIds] = useState<MachineIds | null>(null);
  const [currentIds, setCurrentIds] = useState<MachineIds | null>(null);
  
  // 加载备份列表
  const loadBackups = async () => {
    const result = await CursorService.findBackups();
    setBackups(result);
  };
  
  // 预览备份
  const handlePreview = async (backup: BackupInfo) => {
    const ids = await CursorService.extractIdsFromBackup(backup.path);
    setPreviewIds(ids);
    setSelectedBackup(backup);
  };
  
  // 重置机器ID
  const handleReset = async () => {
    const result = await CursorService.completeCursorReset();
    if (result.success) {
      showToast('机器ID重置成功', 'success');
    }
  };
  
  return (
    <div>
      {/* 当前机器ID显示 */}
      {/* 备份列表 */}
      {/* 重置按钮 */}
    </div>
  );
};
```

## 🔍 故障排除

### 常见问题

#### 1. 找不到 Cursor 安装
**症状**：提示"未检测到 Cursor 安装"

**解决方案**：
- 检查 Cursor 是否已安装
- 使用"设置自定义路径"功能手动指定
- 查看调试信息确认路径

#### 2. 权限不足
**症状**：更新系统ID失败

**解决方案**：
- Windows：以管理员身份运行
- macOS：使用 sudo 权限
- Linux：确保有相应权限

#### 3. 文件被占用
**症状**：无法写入文件

**解决方案**：
- 关闭 Cursor 编辑器
- 检查是否有其他程序占用
- 重启计算机

#### 4. 备份恢复失败
**症状**：从备份恢复后无效

**解决方案**：
- 检查备份文件完整性
- 确认备份文件格式正确
- 手动检查 JSON 格式

## ⚠️ 注意事项

1. **备份重要性**：重置前务必创建备份
2. **关闭编辑器**：操作前关闭 Cursor
3. **权限要求**：某些操作需要管理员权限
4. **文件完整性**：确保配置文件未损坏
5. **兼容性**：不同版本的 Cursor 可能有差异

---

**最后更新**：2025-10-28
**文档版本**：1.0.0

