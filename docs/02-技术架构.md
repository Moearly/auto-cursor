# 02 - 技术架构

## 🏗️ 整体架构

Auto-Cursor 采用混合架构设计，结合了 Rust、TypeScript 和 Python 三种语言的优势：

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层 (UI)                        │
│              React + TypeScript + Tailwind              │
└─────────────────────┬───────────────────────────────────┘
                      │ Tauri IPC
┌─────────────────────▼───────────────────────────────────┐
│                  Tauri 命令层 (Commands)                 │
│                    Rust + Tauri 2.0                     │
├─────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 机器ID管理    │  │  账号管理     │  │  认证检查     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  日志系统     │  │ Python集成   │  │  文件操作     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────┬───────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
┌───────▼──────┐ ┌───▼────┐ ┌─────▼──────────┐
│ SQLite数据库  │ │文件系统│ │ Python脚本执行  │
│ (state.vscdb)│ │(JSON)  │ │ (自动化注册)    │
└──────────────┘ └────────┘ └────────────────┘
```

## 📚 技术栈详解

### 1. 前端技术栈

#### React 19.1.0
- **用途**：构建用户界面
- **特点**：最新版本，性能优化，并发特性
- **组件设计**：函数式组件 + Hooks

#### TypeScript 5.8.3
- **用途**：类型安全的JavaScript
- **配置**：严格模式，完整类型检查
- **优势**：编译时错误检测，更好的IDE支持

#### React Router DOM 7.8.2
- **用途**：前端路由管理
- **路由列表**：
  - `/` - 首页
  - `/machine-id` - 机器ID管理
  - `/auth-check` - 认证检查
  - `/token-manage` - Token管理
  - `/auto-register` - 自动注册
  - `/virtual-card` - 虚拟卡生成

#### Tailwind CSS 3.4.6
- **用途**：原子化CSS框架
- **配置**：自定义主题，响应式设计
- **优势**：快速开发，一致的设计系统

#### Vite 7.0.4
- **用途**：前端构建工具
- **特点**：极速热更新，优化的生产构建
- **插件**：@vitejs/plugin-react

### 2. 后端技术栈

#### Tauri 2.0
- **用途**：桌面应用框架
- **特点**：
  - 小体积（相比Electron）
  - 原生性能
  - 安全的IPC通信
  - 跨平台支持

**Tauri配置**：
```json
{
  "productName": "auto-cursor",
  "version": "0.8.0",
  "identifier": "com.zhuanz.auto-cursor",
  "build": {
    "beforeDevCommand": "pnpm dev",
    "devUrl": "http://localhost:1420",
    "beforeBuildCommand": "pnpm build",
    "frontendDist": "../dist"
  }
}
```

#### Rust (Edition 2024)
- **用途**：后端核心逻辑
- **特点**：内存安全，高性能，零成本抽象
- **编译优化**：
  ```toml
  [profile.release]
  opt-level = "z"      # 优化大小
  lto = true           # 链接时优化
  codegen-units = 1    # 单一代码生成单元
  panic = "abort"      # 使用abort减小大小
  strip = true         # 去除调试符号
  ```

#### 核心依赖库

##### 数据库操作
```toml
rusqlite = { version = "0.29", features = ["bundled"] }
```
- **用途**：SQLite数据库操作
- **特性**：bundled模式，内置SQLite

##### HTTP客户端
```toml
reqwest = { version = "0.11", features = ["json", "gzip", "deflate", "brotli"] }
```
- **用途**：HTTP请求
- **特性**：异步，支持多种压缩格式

##### 序列化
```toml
serde = { version = "1", features = ["derive"] }
serde_json = "1"
```
- **用途**：数据序列化/反序列化
- **特性**：derive宏，JSON支持

##### 异步运行时
```toml
tokio = { version = "1", features = ["full"] }
```
- **用途**：异步任务调度
- **特性**：完整特性集

##### 加密和编码
```toml
sha2 = "0.10"          # SHA256/SHA512哈希
base64 = "0.21"        # Base64编码
hex = "0.4"            # 十六进制编码
uuid = { version = "1.0", features = ["v4"] }  # UUID生成
```

##### 平台特定依赖
```toml
[target.'cfg(windows)'.dependencies]
winreg = "0.50"        # Windows注册表操作

[target.'cfg(target_os = "macos")'.dependencies]
plist = "1.4"          # macOS plist文件操作
```

### 3. Python集成

#### 用途
- 浏览器自动化（Selenium）
- 复杂的注册流程处理
- 邮箱验证码获取

#### 打包方式
```python
# 使用PyInstaller打包为独立可执行文件
pyinstaller --onefile \
  --add-data "cursor_register_manual.py:." \
  --add-data "new_signup.py:." \
  cursor_register_entry.py
```

#### 集成方式
```rust
// Rust调用Python可执行文件
let output = Command::new(&python_exe)
    .arg(&email)
    .arg(&first_name)
    .arg(&last_name)
    .stdout(Stdio::piped())
    .stderr(Stdio::piped())
    .spawn()?
    .wait_with_output()?;
```

## 🔄 数据流架构

### 1. 前端到后端通信

```typescript
// 前端调用Tauri命令
import { invoke } from '@tauri-apps/api/core';

const result = await invoke('reset_machine_ids');
```

```rust
// 后端Tauri命令
#[tauri::command]
async fn reset_machine_ids() -> Result<ResetResult, String> {
    let restorer = MachineIdRestorer::new()?;
    restorer.reset_machine_ids()
        .map_err(|e| e.to_string())
}
```

### 2. 数据持久化

#### SQLite数据库
```
Cursor/User/globalStorage/state.vscdb
├── ItemTable (键值对存储)
│   ├── cursorAuth/accessToken
│   ├── cursorAuth/refreshToken
│   ├── cursorAuth/cachedEmail
│   └── cursorAuth/cachedSignUpType
```

#### JSON文件
```
Cursor/User/globalStorage/storage.json
{
  "telemetry.devDeviceId": "uuid",
  "telemetry.machineId": "sha256",
  "telemetry.macMachineId": "sha512",
  "telemetry.sqmId": "{UUID}",
  "storage.serviceMachineId": "uuid"
}
```

### 3. 事件系统

```typescript
// 前端监听事件
import { listen } from '@tauri-apps/api/event';

await listen('registration-output', (event) => {
  console.log('输出:', event.payload);
});
```

```rust
// 后端发送事件
app.emit("registration-output", payload)?;
```

## 🗂️ 模块架构

### 后端模块结构

```
src-tauri/src/
├── main.rs                 # 应用入口
├── lib.rs                  # Tauri命令注册（37869行）
├── machine_id.rs           # 机器ID管理（1694行）
├── account_manager.rs      # 账号管理（1428行）
├── auth_checker.rs         # 认证检查（2061行）
└── logger.rs               # 日志系统
```

#### lib.rs - 命令中心
```rust
#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_opener::init())
        .plugin(tauri_plugin_fs::init())
        .plugin(tauri_plugin_dialog::init())
        .invoke_handler(tauri::generate_handler![
            // 机器ID管理
            check_cursor_installation,
            get_cursor_paths,
            find_backups,
            extract_ids_from_backup,
            reset_machine_ids,
            complete_cursor_reset,
            
            // 账号管理
            list_accounts,
            switch_account,
            switch_account_with_token,
            add_account,
            delete_account,
            logout_account,
            
            // 认证检查
            check_cursor_auth,
            get_usage_stats,
            get_aggregated_usage,
            
            // 自动注册
            register_cursor_account,
            register_cursor_account_with_config,
            
            // 其他功能
            // ...
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

### 前端模块结构

```
src/
├── pages/                  # 页面组件
│   ├── HomePage.tsx
│   ├── MachineIdPage.tsx
│   ├── AuthCheckPage.tsx
│   ├── TokenManagePage.tsx
│   ├── AutoRegisterPage.tsx
│   └── VirtualCardGeneratorPage.tsx
│
├── components/             # UI组件
│   ├── Layout.tsx
│   ├── Button.tsx
│   ├── LoadingSpinner.tsx
│   ├── Toast.tsx
│   ├── UpdateModal.tsx
│   └── ...
│
├── services/               # 服务层
│   ├── cursorService.ts
│   ├── accountService.ts
│   ├── analyticsService.ts
│   ├── usageService.ts
│   └── updateService.ts
│
├── context/                # React Context
│   └── UsageContext.tsx
│
├── types/                  # TypeScript类型
│   ├── update.ts
│   ├── bankCardConfig.ts
│   └── emailConfig.ts
│
└── utils/                  # 工具函数
    └── cursorToken.ts
```

## 🔐 安全架构

### 1. 权限管理

#### Tauri权限配置
```json
{
  "app": {
    "security": {
      "csp": null
    }
  }
}
```

### 2. 数据加密

#### Token处理
```rust
// SHA256哈希
let mut hasher = Sha256::new();
hasher.update(data);
let result = hasher.finalize();

// Base64编码
let encoded = general_purpose::STANDARD.encode(data);
```

### 3. 进程隔离

```rust
// 创建隐藏的子进程
fn create_hidden_command(program: &str) -> Command {
    #[cfg(target_os = "windows")]
    {
        let mut cmd = Command::new(program);
        cmd.creation_flags(CREATE_NO_WINDOW);
        cmd
    }
    
    #[cfg(not(target_os = "windows"))]
    {
        Command::new(program)
    }
}
```

## 📊 性能优化

### 1. 编译优化
```toml
[profile.release]
opt-level = "z"           # 最小化体积
lto = true                # 链接时优化
codegen-units = 1         # 单一编译单元
strip = true              # 去除符号
```

### 2. 异步处理
```rust
// 使用tokio异步运行时
#[tauri::command]
async fn async_operation() -> Result<String, String> {
    tokio::spawn(async move {
        // 异步操作
    }).await
}
```

### 3. 前端优化
- 代码分割（React.lazy）
- 组件懒加载
- 虚拟滚动（大列表）
- 防抖和节流

## 🔧 构建系统

### Vite配置
```typescript
export default defineConfig({
  plugins: [react()],
  clearScreen: false,
  server: {
    port: 1420,
    strictPort: true,
  },
  build: {
    target: 'esnext',
    minify: 'esbuild',
  }
});
```

### Tauri构建脚本
```bash
# macOS通用二进制
tauri build --target universal-apple-darwin

# Intel Mac
tauri build --target x86_64-apple-darwin

# Apple Silicon
tauri build --target aarch64-apple-darwin
```

## 📦 打包结构

### 应用包内容
```
auto-cursor.app/
├── Contents/
│   ├── MacOS/
│   │   └── auto-cursor          # 主可执行文件
│   ├── Resources/
│   │   ├── icons/               # 应用图标
│   │   └── pyBuild/             # Python可执行文件
│   └── Info.plist               # 应用信息
```

---

**最后更新**：2025-10-28
**文档版本**：1.0.0

