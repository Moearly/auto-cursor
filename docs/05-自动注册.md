# 05 - 自动注册

## 📋 功能概述

自动注册模块通过 Python + Selenium 实现 Cursor 账号的自动化注册流程，支持多种邮箱类型、银行卡绑定和批量注册。

## 🎯 核心功能

### 1. 自动化注册流程
- ✅ 自动填写注册表单
- ✅ 处理 Turnstile 验证
- ✅ 邮箱验证码获取
- ✅ 密码设置
- ✅ 银行卡信息绑定
- ✅ Token 自动提取

### 2. 多种邮箱支持
- ✅ 自定义邮箱
- ✅ Cloudflare 临时邮箱
- ✅ Outlook 邮箱（默认/Token模式）

### 3. 批量注册
- ✅ 批量生成账号
- ✅ 自动分配邮箱
- ✅ 银行卡轮换使用
- ✅ 进度实时显示

### 4. 高级选项
- ✅ 无痕模式
- ✅ 跳过手机验证
- ✅ 美国账户选项
- ✅ 随机用户信息生成

## 🏗️ 架构设计

### Python-Rust 集成架构

```
┌─────────────────────────────────────────┐
│         React 前端界面                   │
│      (AutoRegisterPage.tsx)             │
└──────────────┬──────────────────────────┘
               │ Tauri IPC
┌──────────────▼──────────────────────────┐
│         Rust 后端 (lib.rs)              │
│  register_cursor_account_with_config()  │
└──────────────┬──────────────────────────┘
               │ 子进程调用
┌──────────────▼──────────────────────────┐
│    Python 可执行文件 (PyInstaller)       │
│      cursor_register_entry              │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│       Python 脚本模块                    │
├─────────────────────────────────────────┤
│  • manual_register.py (主入口)          │
│  • cursor_register_manual.py (核心逻辑) │
│  • new_signup.py (注册流程)             │
│  • email_handler.py (邮箱处理)          │
│  • bank_card_handler.py (银行卡)        │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Selenium WebDriver                 │
│      (Chrome/Firefox)                   │
└─────────────────────────────────────────┘
```

## 📝 注册流程

### 完整注册步骤

```
1. 启动浏览器
   ↓
2. 访问注册页面 (cursor.com/signup)
   ↓
3. 填写姓名和邮箱
   ↓
4. 处理 Turnstile 验证（第一次）
   ↓
5. 设置密码
   ↓
6. 处理 Turnstile 验证（第二次）
   ↓
7. 获取邮箱验证码
   ├─→ Cloudflare临时邮箱：自动获取
   ├─→ Outlook邮箱：自动获取
   └─→ 自定义邮箱：手动输入
   ↓
8. 输入验证码
   ↓
9. 跳转到设置页面
   ↓
10. 绑定银行卡（可选）
    ↓
11. 提取 Token
    ↓
12. 保存账号信息
    ↓
13. 完成注册 ✅
```

## 🔧 核心实现

### 1. Rust 调用 Python

```rust
#[tauri::command]
async fn register_cursor_account_with_config(
    email: String,
    first_name: String,
    last_name: String,
    use_incognito: bool,
    enable_bank_card_binding: bool,
    skip_phone_verification: bool,
    config_json: String,
    app_handle: tauri::AppHandle,
) -> Result<serde_json::Value, String> {
    
    // 获取Python可执行文件路径
    let executable_path = get_python_executable_path()?;
    
    // 获取应用目录
    let app_dir = get_app_dir()?;
    let app_dir_base64 = general_purpose::STANDARD.encode(&app_dir);
    
    // 构建命令参数
    let skip_phone = if skip_phone_verification { "1" } else { "0" };
    let use_incognito_str = if use_incognito { "true" } else { "false" };
    let enable_card_str = if enable_bank_card_binding { "true" } else { "false" };
    
    // 创建隐藏的子进程
    let mut child = create_hidden_command(&executable_path.to_string_lossy())
        .arg(&email)
        .arg(&first_name)
        .arg(&last_name)
        .arg(use_incognito_str)
        .arg(&app_dir_base64)
        .arg(enable_card_str)
        .arg(skip_phone)
        .arg(&config_json)
        .stdout(Stdio::piped())
        .stderr(Stdio::piped())
        .spawn()
        .map_err(|e| format!("无法启动Python脚本: {}", e))?;
    
    // 实时读取输出
    if let Some(stdout) = child.stdout.take() {
        let reader = BufReader::new(stdout);
        for line in reader.lines() {
            if let Ok(line) = line {
                // 发送实时输出到前端
                app_handle.emit("registration-output", &line).ok();
            }
        }
    }
    
    // 等待完成
    let output = child.wait_with_output()
        .map_err(|e| format!("等待Python脚本执行失败: {}", e))?;
    
    // 解析结果
    let stdout = String::from_utf8_lossy(&output.stdout);
    let result: serde_json::Value = serde_json::from_str(&stdout)
        .map_err(|e| format!("解析JSON失败: {}", e))?;
    
    Ok(result)
}
```

### 2. Python 主入口

```python
# manual_register.py
def main():
    """主函数"""
    # 解析命令行参数
    email = sys.argv[1]
    first_name = sys.argv[2]
    last_name = sys.argv[3]
    use_incognito = sys.argv[4] == "true"
    app_dir_base64 = sys.argv[5]
    enable_bank_card_binding = sys.argv[6] == "true"
    skip_phone_verification = sys.argv[7] == "1"
    config_json_str = sys.argv[8]
    
    # 解码应用目录
    app_dir = base64.b64decode(app_dir_base64).decode('utf-8')
    
    # 解析配置
    config_dict = json.loads(config_json_str)
    
    # 创建翻译器
    translator = SimpleTranslator()
    
    # 创建注册实例
    registration = CursorRegistration(
        translator=translator,
        app_dir=app_dir,
        enable_bank_card_binding=enable_bank_card_binding
    )
    
    # 设置用户信息
    registration.email_address = email
    registration.first_name = first_name
    registration.last_name = last_name
    registration.use_incognito = use_incognito
    registration.skip_phone_verification = skip_phone_verification
    
    # 设置银行卡配置
    if config_dict.get('bank_card_config'):
        registration.bank_card_config = config_dict['bank_card_config']
    
    # 执行注册
    try:
        if registration.setup_email():
            success = registration.register_cursor()
            
            if success:
                print(json.dumps({
                    "success": True,
                    "email": email,
                    "token": registration.extracted_token,
                    "message": "注册成功"
                }, ensure_ascii=False))
            else:
                print(json.dumps({
                    "success": False,
                    "error": "注册失败"
                }, ensure_ascii=False))
    except Exception as e:
        print(json.dumps({
            "success": False,
            "error": str(e)
        }, ensure_ascii=False))
    finally:
        cleanup_chrome_processes()
```

### 3. 核心注册逻辑

```python
# cursor_register_manual.py
class CursorRegistration:
    def __init__(self, translator, app_dir, enable_bank_card_binding):
        self.translator = translator
        self.app_dir = app_dir
        self.enable_bank_card_binding = enable_bank_card_binding
        self.driver = None
        self.email_address = None
        self.first_name = None
        self.last_name = None
        self.extracted_token = None
    
    def setup_email(self):
        """设置邮箱"""
        # 根据邮箱类型初始化
        if '@' in self.email_address:
            # 自定义邮箱
            return True
        else:
            # 生成临时邮箱
            return self.generate_temp_email()
    
    def register_cursor(self):
        """执行注册流程"""
        try:
            # 1. 启动浏览器
            self.start_browser()
            
            # 2. 访问注册页面
            self.driver.get("https://cursor.com/signup")
            time.sleep(2)
            
            # 3. 填写表单
            self.fill_registration_form()
            
            # 4. 处理验证
            self.handle_turnstile()
            
            # 5. 设置密码
            self.set_password()
            
            # 6. 获取验证码
            verification_code = self.get_verification_code()
            
            # 7. 输入验证码
            self.input_verification_code(verification_code)
            
            # 8. 等待跳转到设置页面
            self.wait_for_settings_page()
            
            # 9. 绑定银行卡
            if self.enable_bank_card_binding:
                self.bind_bank_card()
            
            # 10. 提取Token
            self.extract_token()
            
            # 11. 保存账号
            self.save_account()
            
            return True
            
        except Exception as e:
            print(f"注册失败: {str(e)}")
            return False
        finally:
            if self.driver:
                self.driver.quit()
    
    def fill_registration_form(self):
        """填写注册表单"""
        # 填写名字
        first_name_input = self.driver.find_element(By.NAME, "firstName")
        first_name_input.send_keys(self.first_name)
        
        # 填写姓氏
        last_name_input = self.driver.find_element(By.NAME, "lastName")
        last_name_input.send_keys(self.last_name)
        
        # 填写邮箱
        email_input = self.driver.find_element(By.NAME, "email")
        email_input.send_keys(self.email_address)
        
        # 提交表单
        submit_button = self.driver.find_element(By.CSS_SELECTOR, "button[type='submit']")
        submit_button.click()
    
    def handle_turnstile(self):
        """处理Turnstile验证"""
        # 等待验证框出现
        time.sleep(3)
        
        # 尝试自动点击
        try:
            iframe = self.driver.find_element(By.CSS_SELECTOR, "iframe[src*='turnstile']")
            self.driver.switch_to.frame(iframe)
            
            checkbox = self.driver.find_element(By.CSS_SELECTOR, "input[type='checkbox']")
            checkbox.click()
            
            self.driver.switch_to.default_content()
            time.sleep(2)
        except:
            # 需要手动处理
            print("请手动完成验证")
            time.sleep(10)
    
    def get_verification_code(self):
        """获取验证码"""
        if self.email_type == "cloudflare":
            return self.get_cloudflare_code()
        elif self.email_type == "outlook":
            return self.get_outlook_code()
        else:
            # 手动输入
            return input("请输入验证码: ")
    
    def extract_token(self):
        """提取Token"""
        # 打开开发者工具
        self.driver.execute_script("window.open('', '_blank');")
        self.driver.switch_to.window(self.driver.window_handles[-1])
        
        # 访问设置页面
        self.driver.get("https://cursor.com/settings")
        time.sleep(2)
        
        # 从localStorage获取token
        token = self.driver.execute_script(
            "return localStorage.getItem('cursorAuth/accessToken');"
        )
        
        self.extracted_token = token
        return token
```

## 📧 邮箱处理

### 1. Cloudflare 临时邮箱

```python
def setup_cloudflare_email(self):
    """设置Cloudflare临时邮箱"""
    # 访问临时邮箱服务
    self.driver.get("https://temp-mail.org")
    time.sleep(2)
    
    # 获取临时邮箱地址
    email_element = self.driver.find_element(By.ID, "email")
    self.email_address = email_element.get_attribute("value")
    
    print(f"临时邮箱: {self.email_address}")
    return True

def get_cloudflare_code(self):
    """获取Cloudflare邮箱验证码"""
    # 等待邮件到达
    time.sleep(10)
    
    # 刷新邮箱
    self.driver.refresh()
    time.sleep(2)
    
    # 查找验证码邮件
    emails = self.driver.find_elements(By.CSS_SELECTOR, ".mail-item")
    for email in emails:
        if "Cursor" in email.text:
            email.click()
            time.sleep(2)
            
            # 提取验证码
            code_element = self.driver.find_element(By.CSS_SELECTOR, ".verification-code")
            return code_element.text
    
    return None
```

### 2. Outlook 邮箱

```python
def setup_outlook_email(self, email, password):
    """设置Outlook邮箱"""
    self.email_address = email
    self.outlook_password = password
    return True

def get_outlook_code(self):
    """获取Outlook邮箱验证码"""
    # 打开新标签页
    self.driver.execute_script("window.open('', '_blank');")
    self.driver.switch_to.window(self.driver.window_handles[-1])
    
    # 登录Outlook
    self.driver.get("https://outlook.live.com")
    time.sleep(2)
    
    # 输入邮箱
    email_input = self.driver.find_element(By.NAME, "loginfmt")
    email_input.send_keys(self.email_address)
    email_input.send_keys(Keys.RETURN)
    time.sleep(2)
    
    # 输入密码
    password_input = self.driver.find_element(By.NAME, "passwd")
    password_input.send_keys(self.outlook_password)
    password_input.send_keys(Keys.RETURN)
    time.sleep(5)
    
    # 查找Cursor邮件
    emails = self.driver.find_elements(By.CSS_SELECTOR, "[role='listitem']")
    for email in emails:
        if "Cursor" in email.text:
            email.click()
            time.sleep(2)
            
            # 提取验证码
            body = self.driver.find_element(By.CSS_SELECTOR, "[role='document']")
            text = body.text
            
            # 使用正则提取6位数字
            import re
            match = re.search(r'\b\d{6}\b', text)
            if match:
                return match.group()
    
    return None
```

## 💳 银行卡绑定

### 银行卡配置结构

```typescript
interface BankCardConfig {
  cardNumber: string;        // 卡号
  expiryMonth: string;       // 过期月份
  expiryYear: string;        // 过期年份
  cvv: string;               // CVV
  cardholderName: string;    // 持卡人姓名
  billingAddress: {
    line1: string;           // 地址行1
    line2?: string;          // 地址行2
    city: string;            // 城市
    state: string;           // 州/省
    postalCode: string;      // 邮编
    country: string;         // 国家
  };
}
```

### 绑定实现

```python
def bind_bank_card(self):
    """绑定银行卡"""
    if not self.bank_card_config:
        return False
    
    try:
        # 访问支付设置页面
        self.driver.get("https://cursor.com/settings/billing")
        time.sleep(2)
        
        # 点击添加支付方式
        add_button = self.driver.find_element(By.CSS_SELECTOR, "button[data-testid='add-payment']")
        add_button.click()
        time.sleep(2)
        
        # 切换到Stripe iframe
        stripe_iframe = self.driver.find_element(By.CSS_SELECTOR, "iframe[name*='stripe']")
        self.driver.switch_to.frame(stripe_iframe)
        
        # 填写卡号
        card_number = self.driver.find_element(By.NAME, "cardnumber")
        card_number.send_keys(self.bank_card_config['cardNumber'])
        
        # 填写过期日期
        expiry = self.driver.find_element(By.NAME, "exp-date")
        expiry.send_keys(f"{self.bank_card_config['expiryMonth']}/{self.bank_card_config['expiryYear']}")
        
        # 填写CVV
        cvv = self.driver.find_element(By.NAME, "cvc")
        cvv.send_keys(self.bank_card_config['cvv'])
        
        # 填写邮编
        postal = self.driver.find_element(By.NAME, "postal")
        postal.send_keys(self.bank_card_config['billingAddress']['postalCode'])
        
        # 切回主页面
        self.driver.switch_to.default_content()
        
        # 提交
        submit_button = self.driver.find_element(By.CSS_SELECTOR, "button[type='submit']")
        submit_button.click()
        time.sleep(3)
        
        return True
    except Exception as e:
        print(f"银行卡绑定失败: {str(e)}")
        return False
```

## 📦 PyInstaller 打包

### 打包脚本

```python
# build_executable.py
def build_executable():
    """使用PyInstaller打包可执行文件"""
    
    # 打包命令
    cmd = [
        'pyinstaller',
        '--onefile',                              # 单文件模式
        '--name', 'cursor_register',              # 可执行文件名
        '--add-data', 'cursor_register_manual.py:.',  # 包含依赖
        '--add-data', 'new_signup.py:.',
        '--add-data', 'email_handler.py:.',
        '--hidden-import', 'selenium',            # 隐式导入
        '--hidden-import', 'requests',
        '--noconsole',                            # 无控制台窗口（Windows）
        'cursor_register_entry.py'                # 入口文件
    ]
    
    # 执行打包
    subprocess.run(cmd, check=True)
    
    # 复制到Tauri资源目录
    shutil.copy(
        'dist/cursor_register',
        '../src-tauri/pyBuild/cursor_register'
    )
```

### Tauri 资源配置

```json
{
  "bundle": {
    "resources": ["pyBuild/**/*"]
  }
}
```

## 🎨 前端界面

### 注册表单

```typescript
<div className="space-y-4">
  {/* 邮箱类型选择 */}
  <select value={emailType} onChange={(e) => setEmailType(e.target.value)}>
    <option value="custom">自定义邮箱</option>
    <option value="cloudflare_temp">Cloudflare临时邮箱</option>
    <option value="outlook">Outlook邮箱</option>
  </select>
  
  {/* 用户信息 */}
  <input
    type="text"
    placeholder="名字"
    value={form.firstName}
    onChange={(e) => setForm({...form, firstName: e.target.value})}
  />
  
  <input
    type="text"
    placeholder="姓氏"
    value={form.lastName}
    onChange={(e) => setForm({...form, lastName: e.target.value})}
  />
  
  {/* 高级选项 */}
  <label>
    <input
      type="checkbox"
      checked={useIncognito}
      onChange={(e) => setUseIncognito(e.target.checked)}
    />
    使用无痕模式
  </label>
  
  <label>
    <input
      type="checkbox"
      checked={enableBankCardBinding}
      onChange={(e) => setEnableBankCardBinding(e.target.checked)}
    />
    绑定银行卡
  </label>
  
  {/* 注册按钮 */}
  <button onClick={handleRegister}>
    开始注册
  </button>
</div>
```

### 实时输出显示

```typescript
// 监听实时输出
useEffect(() => {
  const unlisten = listen('registration-output', (event) => {
    setRealtimeOutput(prev => [...prev, event.payload as string]);
  });
  
  return () => {
    unlisten.then(fn => fn());
  };
}, []);

// 显示输出
<div className="bg-black text-green-400 p-4 rounded font-mono text-sm max-h-96 overflow-y-auto">
  {realtimeOutput.map((line, index) => (
    <div key={index}>{line}</div>
  ))}
</div>
```

## 🔍 故障排除

### 常见问题

#### 1. Selenium WebDriver 未找到

**解决方案**：
```bash
# 安装ChromeDriver
# macOS
brew install chromedriver

# Windows
# 下载并添加到PATH
```

#### 2. Turnstile 验证失败

**原因**：Cloudflare的反自动化机制

**解决方案**：
- 使用真实浏览器配置
- 添加随机延迟
- 手动完成验证

#### 3. 验证码获取失败

**解决方案**：
- 增加等待时间
- 检查邮箱服务状态
- 使用手动输入模式

## ⚠️ 注意事项

1. **合规使用**：仅用于学习研究
2. **频率限制**：避免频繁注册
3. **邮箱有效性**：确保邮箱可接收邮件
4. **浏览器版本**：保持WebDriver与浏览器版本匹配
5. **网络环境**：稳定的网络连接

---

**最后更新**：2025-10-28
**文档版本**：1.0.0

